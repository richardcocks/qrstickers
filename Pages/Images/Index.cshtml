@page
@model QRStickers.Pages.Images.IndexModel
@{
    ViewData["Title"] = "Manage Images - " + Model.Connection.DisplayName;
}

<link rel="stylesheet" href="~/css/designer.css" />

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>Manage Images - @Model.Connection.DisplayName</h1>
    <div>
        <button type="button" class="btn btn-primary" onclick="showUploadModal()">
            + Upload Image
        </button>
    </div>
</div>

<!-- Quota Display -->
<div style="padding: 15px; background-color: #f5f5f5; border-radius: 5px; margin-bottom: 20px;">
    <strong>Quota:</strong>
    @Model.Quota.ImagesUsed / @Model.Quota.ImagesLimit images
    (@((Model.Quota.StorageUsed / 1024.0 / 1024.0).ToString("F2")) MB / @((Model.Quota.StorageLimit / 1024.0 / 1024.0).ToString("F0")) MB used)
</div>

@if (!Model.Images.Any())
{
    <div class="alert alert-info">
        <p>No images uploaded yet.</p>
        <p>Click "Upload Image" above to add your first custom image for use in sticker templates.</p>
    </div>
}
else
{
    <!-- Image Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        @foreach (var image in Model.Images)
        {
            <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: white;">
                <!-- Image Preview -->
                <div style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; margin-bottom: 10px; border-radius: 3px; overflow: hidden;">
                    <img src="@image.DataUri" alt="@image.Name"
                         style="max-width: 100%; max-height: 150px; object-fit: contain;" />
                </div>

                <!-- Image Metadata -->
                <div style="margin-bottom: 10px;">
                    <strong style="font-size: 14px;">@image.Name</strong><br />
                    <code style="font-size: 11px; color: #28a745; background: #f0f0f0; padding: 2px 4px; border-radius: 2px;">
                        {{customImage.Image_@image.Id}}
                    </code><br />
                    <span style="font-size: 12px; color: #666;">
                        @image.WidthPx × @image.HeightPx px<br />
                        @((image.FileSizeBytes / 1024.0).ToString("F1")) KB<br />
                        Uploaded: @image.UploadedAt.ToString("g")
                    </span>
                    @if (image.LastUsedAt.HasValue)
                    {
                        <br /><span style="font-size: 11px; color: #28a745;">Last used: @image.LastUsedAt.Value.ToString("g")</span>
                    }
                    else
                    {
                        <br /><span style="font-size: 11px; color: #999;">Never used</span>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(image.Description))
                {
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px; font-style: italic;">
                        @image.Description
                    </div>
                }

                <!-- Actions -->
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-sm btn-danger"
                            onclick="confirmDelete(@image.Id, '@image.Name')">
                        Delete
                    </button>
                </div>
            </div>
        }
    </div>
}

<hr />
<p>
    <a href="/Meraki/Connection?connectionId=@Model.ConnectionId">← Back to @Model.Connection.DisplayName</a> |
    <a href="/Connections">All Connections</a>
</p>

<!-- Upload Modal -->
<div id="uploadModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>Upload Image</h2>
            <button type="button" class="modal-close" onclick="hideUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadForm">
                <input type="hidden" id="connectionId" value="@Model.ConnectionId" />

                <div style="margin-bottom: 15px;">
                    <label for="imageName" style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Image Name: <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="imageName" class="form-control"
                           placeholder="Company Logo"
                           maxlength="200"
                           required />
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Any characters allowed (spaces, unicode, emojis, etc.)<br />
                        <em>Templates will use ID-based binding: <code>{{customImage.Image_<i>ID</i>}}</code></em>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="imageDescription" style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Description: (optional)
                    </label>
                    <input type="text" id="imageDescription" class="form-control"
                           placeholder="Optional description"
                           maxlength="1000" />
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="imageFile" style="display: block; margin-bottom: 5px; font-weight: bold;">
                        File: <span style="color: red;">*</span>
                    </label>
                    <input type="file" id="imageFile" class="form-control"
                           accept="image/png,image/jpeg,image/webp,image/svg+xml"
                           required />
                </div>

                <!-- Preview -->
                <div id="previewContainer" style="display: none; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Preview:</label>
                    <div style="max-width: 300px; max-height: 300px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">
                        <img id="imagePreview" style="max-width: 100%; max-height: 280px; object-fit: contain;" />
                    </div>
                    <div id="imageDimensions" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                </div>

                <!-- Limits -->
                <div style="background: #f5f5f5; padding: 10px; border-radius: 3px; font-size: 12px; margin-bottom: 15px;">
                    <strong>Limits:</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        <li>Max 900×900 px</li>
                        <li>Max 2 MB</li>
                        <li>PNG, JPEG, WebP, SVG</li>
                    </ul>
                </div>

                <!-- Error Display -->
                <div id="uploadError" class="alert alert-danger" style="display: none;"></div>

                <!-- Success Display -->
                <div id="uploadSuccess" class="alert alert-success" style="display: none;"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideUploadModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="uploadButton" onclick="uploadImage()">Upload Image</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Delete Image</h2>
            <button type="button" class="modal-close" onclick="hideDeleteModal()">&times;</button>
        </div>
        <div class="modal-body" style="flex-direction: column;">
            <p>Are you sure you want to delete the image "<strong id="deleteImageName"></strong>"?</p>
            <p style="font-size: 14px; color: #666;">
                This will replace the image with a transparent placeholder.
                Templates using this image will show an empty box.
            </p>
            <input type="hidden" id="deleteImageId" />
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="deleteImage()">Delete Image</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/image-upload.js"></script>
}
